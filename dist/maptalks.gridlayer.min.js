/*!
 * maptalks.gridlayer v0.2.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@>=0.26.2 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),i=0;i<r.length;i++){var o=r[i],n=Object.getOwnPropertyDescriptor(e,o);n&&n.configurable&&void 0===t[o]&&Object.defineProperty(t,o,n)}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}function a(t,r){var i=t.getGridProjection(),o=t.getMap(),n=new e.Coordinate(r.center),a=o.coordinateToPoint(n),s=i.project(n)._add(r.width,r.height),l=o._prjToPoint(s);return[Math.abs(l.x-a.x),Math.abs(l.y-a.y)]}var s={lineColor:"#bbb",lineWidth:1,lineOpacity:1,lineDasharray:[],lineCap:"butt",lineJoin:"round",polygonOpacity:0},l={symbol:e.Util.extend({},s),debug:!1},h=function(t){function r(e,n,a){i(this,r);var s=o(this,t.call(this,e,a));return n.unit||(n.unit="projection"),s._grid=n,s}return n(r,t),r.prototype.getGrid=function(){return this._grid},r.prototype.setGrid=function(t){return this._grid=t,this.redraw()},r.prototype.setGridData=function(t){return this._grid.data=t,this.redraw()},r.prototype.redraw=function(){var t=this._getRenderer();return t?(t.redraw(),this):this},r.prototype.isEmpty=function(){return!this._grid},r.prototype.clear=function(){return delete this._grid,this.fire("clear"),this.redraw()},r.prototype.getGridProjection=function(){return this.options.projectionName?e.projection[this.options.projectionName.toUpperCase()]:this.getMap().getProjection()},r.prototype.getGridExtent=function(){var t=this.getGrid(),r=new e.Coordinate(t.center),i=this.getMap(),o=t.width,n=t.height,a=t.cols||[-1/0,1/0],s=t.rows||[-1/0,1/0];if("projection"===t.unit){var l=this.getGridProjection(),h=l.project(r),c=h.x+a[0]*o,d=h.x+a[1]*o,p=h.y+a[0]*n,y=h.y+a[1]*n;return new e.Extent(c,p,d,y).convertTo(function(t){return l.unproject(t)})}if("meter"===t.unit){var u=i.locate(r,-o*a[0],-n*s[0]),g=i.locate(r,o*a[1],n*s[1]);return new e.Extent(u,g)}if("degree"===t.unit){var f=r.add(o*a[0],n*s[0]),m=r.add(o*a[1],n*s[1]);return new e.Extent(f,m)}return null},r.prototype.getCellAt=function(t){var r=this.getGrid(),i=this.getMap();if(!this.getGridExtent().contains(t))return null;var o=new e.Coordinate(r.center);if("projection"===r.unit){var n=i.coordinateToPoint(o),s=a(this,r),l=i.coordinateToPoint(t);return[Math.floor((l.x-n.x)/s[0]),Math.floor((l.y-n.y)/s[0])]}if("meter"===r.unit){var h=i.computeLength(new e.Coordinate(t.x,o.y),o),c=Math.floor(h/r.width),d=i.computeLength(new e.Coordinate(o.x,t.y),o);return[c,Math.floor(d/r.height)]}if("degree"===r.unit){var p=t.x-o.x,y=Math.floor(p/r.width),u=t.y-o.y;return[y,Math.floor(u/r.height)]}return null},r.prototype.getCellGeometry=function(t,r){var i=this.getMap(),o=this.getGrid(),n=new e.Coordinate(o.center);if("projection"===o.unit){var s=i.coordinateToPoint(n),l=a(this,o),h=l[0],c=l[1],d=s.add(h*t,c*r),p=i.pointToCoordinate(d),y=i.pointToCoordinate(d.add(h,0)),u=i.pointToCoordinate(d.add(0,c)),g=i.computeLength(p,y),f=i.computeLength(p,u);return new e.Rectangle(p,g,f)}return"meter"===o.unit?null:"degree"===o.unit?n.add(o.width*t,o.height*r):null},r.prototype.visitAround=function(t,e){var r=this.getGrid(),i=r.data;if(t&&r.data&&e){for(var o=[],n=0;n<i.length;n++){var a=i[n][0],s=i[n][1],l=i[n][2];Array.isArray(a)||(a=[a,a]),Array.isArray(s)||(s=[s,s]);for(var h=a[0];h<=a[1];h++)for(var c=s[0];c<=s[1];c++)o.push([h,c,l])}if(o.length)for(var d=this.getCellAt(t),p=o.sort(function(t,e){return Math.pow(t[0]-d[0],2)+Math.pow(t[1]-d[1],2)-Math.pow(e[0]-d[0],2)-Math.pow(e[1]-d[1],2)}),y=0,u=p.length;y<u&&!1!==e(p[y]);y++);}},r.prototype.identify=function(t){if(!t)return null;if(!this.getGridExtent().contains(t))return null;var e=this.getCellAt(t),r=this.getCellGeometry(e[0],e[1]);return{col:e[0],row:e[1],geometry:r}},r.prototype.toJSON=function(){var t=this.getGrid();return t.center instanceof e.Coordinate&&(t.center=t.center.toArray()),{type:"GridLayer",id:this.getId(),options:this.config(),grid:t}},r.fromJSON=function(t){return t&&"GridLayer"===t.type?new r(t.id,t.grid,t.options):null},r}(e.Layer);h.mergeOptions(l),h.registerJSONType("GridLayer");var c=[e.symbolizer.ImageMarkerSymbolizer,e.symbolizer.TextMarkerSymbolizer,e.symbolizer.VectorMarkerSymbolizer,e.symbolizer.VectorPathMarkerSymbolizer];h.registerRenderer("canvas",function(t){function r(){return i(this,r),o(this,t.apply(this,arguments))}return n(r,t),r.prototype.needToRedraw=function(){var e=this.getMap();return!(!e.getPitch()&&e.isZooming())&&t.prototype.needToRedraw.call(this)},r.prototype.draw=function(){this.layer.getGrid()?(this.prepareCanvas(),this._setCanvasStyle(this._compiledGridStyle),this._drawGrid(),this._drawData(),this.completeRender()):this.completeRender()},r.prototype.drawOnInteracting=function(){this.draw()},r.prototype.checkResources=function(){if(this._compileStyles(),this._resources)return null;var t=[];return this._compiledGridStyle&&(t=e.Util.getExternalResources(this._compiledGridStyle)),this._compiledSymbols&&this._compiledSymbols.forEach(function(r){var i=e.Util.getExternalResources(r);i&&(t=t.concat(i))}),t},r.prototype.redraw=function(){this.setToRedraw()},r.prototype._compileStyles=function(){var t=this;if(!this._compiledGridStyle){var r=e.Util.convertResourceUrl(this.layer.options.symbol);this._compiledGridStyle=e.MapboxUtil.loadFunctionTypes(r,function(){return[t.getMap()?t.getMap().getZoom():null,null]})}if(!this._compiledSymbols){var i=this.getMap(),o=this.layer.getGrid().data;this._compiledSymbols=[],o&&o.forEach(function(r,o){if(r[2].symbol){var n=function(t){return function(){return[i.getZoom(),t]}}(r[2].properties),a=e.Util.convertResourceUrl(r[2].symbol);t._compiledSymbols[o]=e.MapboxUtil.loadFunctionTypes(a,n)}})}},r.prototype._drawGrid=function(){var t="projection"===this.layer.getGrid().unit?this._getProjGridToDraw():this._getGridToDraw();if(!(!t||this._compiledGridStyle.lineOpacity<=0||this._compiledGridStyle.lineWidth<=0)){var r=t.cols,i=t.rows,o=t.width,n=t.height,a=this._getCellNW(r[0],i[0],t),s=void 0,l=void 0;if(this.context.beginPath(),!((o<.5||n<.5||this._compiledGridStyle.polygonOpacity>0||this._compiledGridStyle.polygonColor||this._compiledGridStyle.polygonPatternFile)&&(l=this._getCellNW(r[1]+1,i[1]+1,t),this.context.rect(a.x,a.y,l.x-a.x,l.y-a.y),this._compiledGridStyle.polygonOpacity>0?e.Canvas.fillCanvas(this.context,this._compiledGridStyle.polygonOpacity,a.x,a.y):e.Canvas.fillCanvas(this.context,1,a.x,a.y),o<.5||n<.5))){for(var h=r[0];h<=r[1];h++)s=this._getCellNW(h,i[0],t),l=this._getCellNW(h,i[1],t),this.context.moveTo(s.x,s.y),this.context.lineTo(l.x,l.y);for(var c=i[0];c<=i[1];c++)s=this._getCellNW(r[0],c,t),l=this._getCellNW(r[1],c,t),this.context.moveTo(s.x,s.y),this.context.lineTo(l.x,l.y);e.Canvas._stroke(this.context,this._compiledGridStyle.lineOpacity,a.x,a.y)}}},r.prototype._getProjGridToDraw=function(){var t=this.layer.getGrid(),r=this.getMap(),i=r._get2DExtent(),o=t.cols||[-1/0,1/0],n=t.rows||[-1/0,1/0],s=new e.Coordinate(t.center),l=r.coordinateToPoint(s),h=a(this.layer,t),c=h[0],d=h[1],p=new e.PointExtent(l.x+o[0]*c,l.y+n[0]*d,l.x+o[1]*c,l.y+n[1]*d),y=i.intersection(p);if(!y)return null;return{cols:[-Math.ceil((l.x-y.xmin-1e-6)/c),Math.ceil((y.xmax-l.x-1e-6)/c)],rows:[-Math.ceil((l.y-y.ymin-1e-6)/d),Math.ceil((y.ymax-l.y-1e-6)/d)],width:Math.round(c),height:Math.round(d),center:l}},r.prototype._getGridToDraw=function(){var t=this.layer.getGrid(),r=this.getMap(),i=r.getExtent(),o=new e.Coordinate(t.center),n=this.layer.getGridExtent(),a=t.width,s=t.height,l=i.intersection(n);if(!l)return null;var h=void 0,c=void 0;if("meter"===t.unit){var d=r.computeLength(new e.Coordinate(l.xmin,o.y),o),p=r.computeLength(new e.Coordinate(l.xmax,o.y),o),y=r.computeLength(new e.Coordinate(o.y,l.ymin),o),u=r.computeLength(new e.Coordinate(l.ymax,o.y),o);h=[-Math.ceil(d/t.width),Math.ceil(p/t.width)],c=[-Math.ceil(y/t.height),Math.ceil(u/t.height)]}else"degree"===t.unit&&(h=[-Math.ceil((o.x-l.xmin-1e-6)/a),Math.ceil((l.xmax-o.x-1e-6)/a)],c=[-Math.ceil((o.y-l.ymin-1e-6)/s),Math.ceil((l.ymax-o.y-1e-6)/s)]);return{cols:h,rows:c,center:o}},r.prototype._getCellNW=function(t,r,i){var o=this.getMap(),n=this.layer.getGrid();if("projection"===n.unit){var a=new e.Point(i.center.x+t*i.width,i.center.y+r*i.height);return o._pointToContainerPoint(a)._floor()}if("meter"===n.unit){var s=new e.Coordinate(n.center),l=o.locate(s,n.width*t,n.height*r);return o.coordinateToContainerPoint(l)._floor()}if("degree"===n.unit){var h=new e.Coordinate(n.center).add(t*n.width,r*n.height);return o.coordinateToContainerPoint(h)._floor()}return null},r.prototype._getCellCenter=function(t,r,i){var o=this.layer.getGrid(),n=this.getMap();if("projection"===o.unit){var a=new e.Point(i.center.x+(t+.5)*i.width,i.center.y+(r+.5)*i.height);return n.pointToCoordinate(a)}if("meter"===o.unit){var s=new e.Coordinate(o.center);return n.locate(s,o.width*(t+.5),o.height*(r+.5))}return"degree"===o.unit?new e.Coordinate(o.center).add(o.width*(t+.5),o.height*(r+.5)):null},r.prototype._drawData=function(){var t=this,r=this.layer.getGrid(),i="projection"===r.unit?this._getProjGridToDraw():this._getGridToDraw(),o=r.data;i&&Array.isArray(o)&&o.length&&(this._gridSymbolTests||(this._gridSymbolTests=[]),o.forEach(function(r,o){r[2].symbol&&(t._drawDataGrid(r,t._compiledSymbols[o],i),e.Util.isNil(t._gridSymbolTests[o])&&(t._gridSymbolTests[o]=t._testSymbol(r[2].symbol)),t._gridSymbolTests[o]&&t._drawDataCenter(r,o,i))}))},r.prototype._drawDataGrid=function(t,r,i){for(var o=this.context,n=this.getMap().getContainerExtent(),a=!1,s=Array.isArray(t[0])?t[0]:[t[0],t[0]],l=Array.isArray(t[1])?t[1]:[t[1],t[1]],h=this._getCellNW(s[0],l[0],i),c=void 0,d=void 0,p=void 0,y=void 0,u=void 0,g=s[0];g<=s[1];g++)for(var f=l[0];f<=l[1];f++)c=this._getCellNW(g,f,i),d=this._getCellNW(g+1,f,i),p=this._getCellNW(g+1,f+1,i),y=this._getCellNW(g,f+1,i),(u=new e.PointExtent(c.x,c.y,p.x,p.y)).getWidth()>1e4||u.getHeight()>1e4||!n.intersects(u)||(a||(a=!0,this._setCanvasStyle(r),o.beginPath()),o.moveTo(c.x,c.y),o.lineTo(d.x,d.y),o.lineTo(p.x,p.y),o.lineTo(y.x,y.y),o.closePath());a&&(e.Canvas.fillCanvas(o,r.polygonOpacity,h.x,h.y),e.Canvas._stroke(o,r.lineOpacity))},r.prototype._testSymbol=function(t){for(var e=c.length-1;e>=0;e--)if(c[e].test(t))return!0;return!1},r.prototype._drawDataCenter=function(t,r,i){var o=t[2].symbol,n=this.getMap().getExtent(),a=this._dataMarkers;a||(this._dataMarkers=a=[]);var s=[];if(Array.isArray(t[0])||Array.isArray(t[1]))for(var l=Array.isArray(t[0])?t[0]:[t[0],t[0]],h=Array.isArray(t[1])?t[1]:[t[1],t[1]],c=l[0];c<=l[1];c++)for(var d=h[0];d<=h[1];d++){var p=this._getCellCenter(c,d,i);n.contains(p)&&s.push(p)}else{var y=this._getCellCenter(t[0],t[1],i);n.contains(y)&&s.push(y)}if(0!==s.length){var u=a[r];if(u)u.setCoordinates(s);else{var g=e.Util.extend({},o);g.markerPlacement="point",g.textPlacement="point",g.lineOpacity=0,g.polygonOpacity=0,(u=new e.LineString(s,{symbol:g,properties:t[2].properties,debug:this.layer.options.debug}))._bindLayer(this.layer),a[r]=u}u._getPainter().paint()}},r.prototype._setCanvasStyle=function(t){var r=e.Util.extend({},s,t);e.Canvas.prepareCanvas(this.context,r,this._resources)},r.prototype.onRemove=function(){delete this._compiledGridStyle,delete this._compiledSymbols,delete this._gridSymbolTests,delete this._dataMarkers},r}(e.renderer.CanvasRenderer)),t.GridLayer=h,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.gridlayer v0.2.0, requires maptalks@>=0.26.2.")});