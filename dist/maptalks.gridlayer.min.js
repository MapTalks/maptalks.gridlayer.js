/*!
 * maptalks.gridlayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),i=0;i<r.length;i++){var o=r[i],n=Object.getOwnPropertyDescriptor(e,o);n&&n.configurable&&void 0===t[o]&&Object.defineProperty(t,o,n)}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var a={lineColor:"#bbb",lineWidth:1,lineOpacity:1,lineDasharray:[],lineCap:"butt",lineJoin:"round",polygonOpacity:0},s={symbol:e.Util.extend({},a),debug:!1},l=function(t){function r(e,n,a){i(this,r);var s=o(this,t.call(this,e,a));return s._grid=n,s}return n(r,t),r.prototype.getGrid=function(){return this._grid},r.prototype.setGrid=function(t){return this._grid=t,this.redraw()},r.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer().redraw(),this},r.prototype.isEmpty=function(){return!this._grid},r.prototype.clear=function(){return delete this._grid,this.fire("clear"),this.redraw()},r.prototype.identify=function(t){var r=this.getMap(),i=this.getGrid(),o=i.cols||["*","*"],n=i.rows||["*","*"];if(i.projection){var a=r._getResolution(),s=i.width/a,l=i.height/a,c=r.coordinateToContainerPoint(new e.Coordinate(i.center)),h=r.coordinateToContainerPoint(t),p=new e.Extent("*"===o[0]?-Number.MAX_VALUE:c.x+o[0]*s,"*"===n[0]?-Number.MAX_VALUE:c.y+n[0]*l,"*"===o[1]?Number.MAX_VALUE:c.x+o[1]*s,"*"===n[1]?Number.MAX_VALUE:c.y+n[1]*l);if(!p.contains(h))return null;var y=1e-6,d=Math.ceil(Math.abs(h.x-c.x)/s-y),u=Math.ceil(Math.abs(h.y-c.y)/l-y);d=h.x>c.x?d-1:-d,u=h.y>c.y?u-1:-u;var g=c.add(s*d,l*u),f=r.containerPointToCoordinate(g),m=r.containerPointToCoordinate(g.add(s,0)),_=r.containerPointToCoordinate(g.add(0,l)),b=r.computeLength(f,m),v=r.computeLength(f,_);return new e.Rectangle(f,b,v)}return null},r.prototype.toJSON=function(){var t=this.getGrid();return t.center instanceof e.Coordinate&&(t.center=t.center.toArray()),{type:"GridLayer",id:this.getId(),options:this.config(),grid:t}},r.fromJSON=function(t){return t&&"GridLayer"===t.type?new r(t.id,t.grid,t.options):null},r}(e.Layer);l.mergeOptions(s),l.registerJSONType("GridLayer");var c=[e.symbolizer.ImageMarkerSymbolizer,e.symbolizer.TextMarkerSymbolizer,e.symbolizer.VectorMarkerSymbolizer,e.symbolizer.VectorPathMarkerSymbolizer];l.registerRenderer("canvas",function(t){function r(){return i(this,r),o(this,t.apply(this,arguments))}return n(r,t),r.prototype.draw=function(){var t=this.layer.getGrid();return t?(this.prepareCanvas(),this._setCanvasStyle(this._compiledGridStyle),this._drawGrid(),this._drawData(),void this.completeRender()):void this.completeRender()},r.prototype.checkResources=function(){if(this._compileStyles(),this._resources)return null;var t=[];return this._compiledGridStyle&&(t=e.Util.getExternalResources(this._compiledGridStyle)),this._compiledSymbols&&this._compiledSymbols.forEach(function(r){var i=e.Util.getExternalResources(r);i&&(t=t.concat(i))}),t},r.prototype.redraw=function(){},r.prototype._compileStyles=function(){var t=this;if(!this._compiledGridStyle){var r=e.Util.convertResourceUrl(this.layer.options.symbol);this._compiledGridStyle=e.MapboxUtil.loadFunctionTypes(r,function(){return[t.getMap()?t.getMap().getZoom():null,null]})}if(!this._compiledSymbols){var i=this.getMap(),o=this.layer.getGrid(),n=o.data;this._compiledSymbols=[],n&&n.forEach(function(r,o){if(r[2].symbol){var n=function(t){return function(){return[i.getZoom(),t]}}(r[2].properties),a=e.Util.convertResourceUrl(r[2].symbol);t._compiledSymbols[o]=e.MapboxUtil.loadFunctionTypes(a,n)}})}},r.prototype._drawGrid=function(){var t=this.layer.getGrid(),r=t.projection?this._getProjGridToDraw():this._getGridToDraw();if(r){var i,o,n=r.cols,a=r.rows,s=r.width,l=r.height,c=this._getCellNW(n[0],a[0],r);if(this.context.beginPath(),!((s<.5||l<.5||this._compiledGridStyle.polygonOpacity>0||this._compiledGridStyle.polygonColor||this._compiledGridStyle.polygonPatternFile)&&(o=this._getCellNW(n[1]+1,a[1]+1,r),this.context.rect(c[0],c[1],o[0]-c[0],o[1]-c[1]),this._compiledGridStyle.polygonOpacity>0?e.Canvas.fillCanvas(this.context,this._compiledGridStyle.polygonOpacity,c[0],c[1]):e.Canvas.fillCanvas(this.context,1,c[0],c[1]),s<.5||l<.5))){for(var h=n[0];h<=n[1]+1;h++)i=this._getCellNW(h,a[0],r),o=this._getCellNW(h,a[1]+1,r),this.context.moveTo(i[0],i[1]),this.context.lineTo(o[0],o[1]);for(var p=a[0];p<=a[1]+1;p++)i=this._getCellNW(n[0],p,r),o=this._getCellNW(n[1]+1,p,r),this.context.moveTo(i[0],i[1]),this.context.lineTo(o[0],o[1]);e.Canvas._stroke(this.context,this._compiledGridStyle.lineOpacity,c[0],c[1])}}},r.prototype._getProjGridToDraw=function(){var t=this.layer.getGrid(),r=this.getMap(),i=r.getSize(),o=r._getResolution(),n=t.cols||["*","*"],a=t.rows||["*","*"],s=r.coordinateToContainerPoint(new e.Coordinate(t.center)),l=t.width/o,c=t.height/o,h=1e-6,p=-s.x+i.width,y=-s.y+i.height,d=new e.PointExtent(-s.x>0?Math.ceil(-s.x/l-h)-1:-Math.ceil(s.x/l-h),-s.y>0?Math.ceil(-s.y/c-h)-1:-Math.ceil(s.y/c-h),p>0?Math.ceil(p/l-h):-Math.ceil(p/l-h),y>0?Math.ceil(y/c-h):-Math.ceil(y/c-h)),u=new e.PointExtent("*"===n[0]?d.xmin:n[0],"*"===a[0]?d.ymin:a[0],"*"===n[1]?d.xmax:n[1],"*"===a[1]?d.ymax:a[1]),g=d.intersection(u);return g?{cols:[g.xmin,g.xmax],rows:[g.ymin,g.ymax],width:l,height:c,center:s}:null},r.prototype._getCellNW=function(t,e,r){var i=this.layer.getGrid();return i.projection?[r.center.x+(t>0?t-1:t)*r.width,r.center.y+(e>0?e-1:e)*r.height]:null},r.prototype._getCellCenter=function(t,e,r){var i=this.layer.getGrid();return i.projection?[r.center.x+((t>0?t-1:t)+.5)*r.width,r.center.y+((e>0?e-1:e)+.5)*r.height]:null},r.prototype._drawData=function(){var t=this,r=this.layer.getGrid(),i=r.projection?this._getProjGridToDraw():this._getGridToDraw(),o=r.data;Array.isArray(o)&&o.length&&(this._gridSymbolTests||(this._gridSymbolTests=[]),o.forEach(function(r,o){r[2].symbol&&(t._drawDataGrid(r,t._compiledSymbols[o],i),e.Util.isNil(t._gridSymbolTests[o])&&(t._gridSymbolTests[o]=t._testSymbol(r[2].symbol)),t._gridSymbolTests[o]&&t._drawDataCenter(r,o,i))}))},r.prototype._drawDataGrid=function(t,r,i){for(var o,n,a,s=this.getMap(),l=s.getSize(),c=new e.PointExtent(0,0,l.width,l.height),h=!1,p=Array.isArray(t[0])?t[0]:[t[0],t[0]],y=Array.isArray(t[1])?t[1]:[t[1],t[1]],d=this._getCellNW(p[0],y[0],i),u=p[0];u<=p[1];u++)for(var g=y[0];g<=y[1];g++)o=this._getCellNW(u,g,i),n=this._getCellNW(u+1,g+1,i),a=new e.PointExtent(o[0],o[1],n[0],n[1]),c.intersects(a)&&(h||(h=!0,this._setCanvasStyle(r),this.context.beginPath()),this.context.rect(Math.ceil(o[0]),Math.ceil(o[1]),Math.ceil(n[0]-o[0]),Math.ceil(n[1]-o[1])));h&&e.Canvas.fillCanvas(this.context,r.polygonOpacity,d[0],d[1])},r.prototype._testSymbol=function(t){for(var e=c.length-1;e>=0;e--)if(c[e].test(t))return!0;return!1},r.prototype._drawDataCenter=function(t,r,i){var o=t[2].symbol,n=this.getMap(),a=n.getExtent(),s=this._dataMarkers;s||(this._dataMarkers=s=[]);for(var l,c,h=[],p=Array.isArray(t[0])?t[0]:[t[0],t[0]],y=Array.isArray(t[1])?t[1]:[t[1],t[1]],d=p[0];d<=p[1];d++)for(var u=y[0];u<=y[1];u++)l=this._getCellCenter(d,u,i),c=n.containerPointToCoordinate(new e.Point(l)),a.contains(c)&&h.push(c);if(0!==h.length){var g=s[r];if(g)g.setCoordinates(h);else{var f=e.Util.extend({},o);f.markerPlacement="point",f.textPlacement="point",f.lineOpacity=0,f.polygonOpacity=0,g=new e.LineString(h,{symbol:f,properties:t[2].properties,debug:this.layer.options.debug}),g._bindLayer(this.layer),s[r]=g}g._getPainter().paint()}},r.prototype._setCanvasStyle=function(t){var r=e.Util.extend({},a,t);e.Canvas.prepareCanvas(this.context,r,this._resources)},r.prototype.onRemove=function(){delete this._compiledGridStyle,delete this._compiledSymbols,delete this._gridSymbolTests,delete this._dataMarkers},r}(e.renderer.CanvasRenderer)),t.GridLayer=l,Object.defineProperty(t,"__esModule",{value:!0})});